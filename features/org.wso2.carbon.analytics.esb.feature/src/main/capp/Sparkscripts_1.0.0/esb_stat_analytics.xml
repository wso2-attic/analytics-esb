<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Analytics>
    <Name>esb_stat_analytics</Name>
    <Script>
        CREATE TEMPORARY TABLE esbServiceStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Minute",
        incrementalParams "esbServiceStatPerMinute, 3600",
        mergeSchema "false");

        CREATE TEMPORARY TABLE mediatorStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "mediator-stat-per-minute",
        incrementalParams "mediatorStatPerMinute, 3600",
        mergeSchema "false");

        CREATE TEMPORARY TABLE esbServiceStatPerHour USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Hour",
        schema "year INT -i, month INT -i, day INT -i, hour INT -I, componentId FACET -i,
        componentName FACET -i, componentType FACET -i, totalDuration LONG, minDuration INT, maxDuration INT,
        noOfInvocation LONG -sp, faultCount LONG, startingTime LONG -i, facetStartTime FACET -i, entryPoint FACET -i,
        _timestamp LONG -i",
        primaryKeys "year, month, day, hour, componentId, componentType",
        incrementalParams "esbServiceStatPerHour, 86400",
        mergeSchema "false");

        INSERT INTO TABLE esbServiceStatPerHour
        SELECT year, month, day, hour, componentId, componentName, componentType,
        sum(totalDuration) as totalDuration, min(minDuration) as minDuration, max(maxDuration) as maxDuration,
        sum(noOfInvocation) as noOfInvocation, sum(faultCount) as faultCount,
        getHourStartingTime(year, month, day, hour) as startingTime,
        cast(getHourStartingTime(year, month, day, hour) as STRING) as facetStartTime, entryPoint,
        getHourStartingTime(year, month, day, hour) as _timestamp
        FROM esbServiceStatPerMinute
        GROUP BY
        year, month, day, hour, componentId, componentName, componentType, entryPoint;

        INCREMENTAL_TABLE_COMMIT esbServiceStatPerMinute;

        CREATE TEMPORARY TABLE esbServiceStatPerHourAll USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Hour",
        schema "year INT -i, month INT -i, day INT -i, hour INT -I, componentId FACET -i,
        componentName FACET -i, componentType FACET -i, totalDuration LONG, minDuration INT, maxDuration INT,
        noOfInvocation LONG -sp, faultCount LONG, startingTime LONG -i, facetStartTime FACET -i, entryPoint FACET -i,
        _timestamp LONG -i",
        primaryKeys "year, month, day, hour, componentId, componentType",
        mergeSchema "false");

        INSERT INTO TABLE esbServiceStatPerHourAll
        SELECT year, month, day, hour, "ALL", "ALL", "ALL", totalDuration, minDuration, maxDuration,
        noOfInvocation, faultCount, startingTime, facetStartTime, "ALL", _timestamp
        FROM
        (SELECT year, month, day, hour, sum(totalDuration) as totalDuration, min(minDuration) as minDuration,
        max(maxDuration) as maxDuration, sum(noOfInvocation) as noOfInvocation, sum(faultCount) as faultCount,
        getHourStartingTime(year, month, day, hour) as startingTime,
        cast(getHourStartingTime(year, month, day, hour) as STRING) as facetStartTime,
        getHourStartingTime(year, month, day, hour) as _timestamp
        FROM esbServiceStatPerHour
        WHERE componentType = "Proxy Service" OR componentType = "API" OR componentType = "Inbound EndPoint"
        GROUP BY
        year, month, day, hour) temp;

        CREATE TEMPORARY TABLE mediatorStatPerHour USING CarbonAnalytics
        OPTIONS (tableName "mediator-stat-per-hour",
        schema "year INT -i, month INT -i, day INT -i, hour INT -I, entryPoint FACET -i, entryPointHashcode INT -i,
        componentIndex INT, componentId FACET -i,
       hashCode LONG -i, componentName FACET -i, componentType FACET -i, totalDuration LONG, minDuration INT,
        maxDuration INT, noOfInvocation LONG -sp, faultCount LONG, startingTime LONG -i, facetStartTime FACET -i,
        _timestamp  LONG -i",
        primaryKeys "year, month, day, hour, entryPointHashcode, hashCode, componentId, componentType",
        incrementalParams "mediatorStatPerHour, 86400",
        mergeSchema "false");

        INSERT INTO TABLE mediatorStatPerHour
        SELECT year, month, day, hour, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode,
        componentName, componentType, sum(totalDuration) as totalDuration, min(minDuration) as minDuration,
        max(maxDuration) as maxDuration, sum(noOfInvocation) as noOfInvocation, sum(faultCount) as faultCount,
        getHourStartingTime(year, month, day, hour) as startingTime,
        cast(getHourStartingTime(year, month, day, hour) as STRING) as facetStartTime,
        getHourStartingTime(year, month, day, hour) as _timestamp
        FROM mediatorStatPerMinute
        GROUP BY year, month, day, hour, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode,
        componentName, componentType;

        INCREMENTAL_TABLE_COMMIT mediatorStatPerMinute;

        CREATE TEMPORARY TABLE esbServiceStatPerDay USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Day",
        schema "year INT -i, month INT -i, day INT -i, componentId FACET -i, componentName FACET -i,
        componentType FACET -i, totalDuration LONG, minDuration INT, maxDuration INT, noOfInvocation LONG -sp,
        faultCount LONG, startingTime LONG -i, facetStartTime FACET -i, entryPoint FACET -i, _timestamp LONG -i",
        primaryKeys "year, month, day, componentId, componentType",
        incrementalParams "esbServiceStatPerDay, 2678400",
        mergeSchema "false");

        INSERT INTO TABLE esbServiceStatPerDay
        SELECT year, month, day, componentId, componentName, componentType,
        sum(totalDuration) as totalDuration, min(minDuration) as minDuration, max(maxDuration) as maxDuration,
        sum(noOfInvocation) as noOfInvocation, sum(faultCount) as faultCount,
        getDateStartingTime(year, month, day) as startingTime,
        cast(getDateStartingTime(year, month, day) as STRING) as facetStartTime, entryPoint, getDateStartingTime(year,
        month, day) as _timestamp
        FROM esbServiceStatPerHour
        GROUP BY year, month, day, componentId, componentName, componentType, entryPoint;

        INCREMENTAL_TABLE_COMMIT esbServiceStatPerHour;

        CREATE TEMPORARY TABLE esbServiceStatPerDayAll USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Day",
        schema "year INT -i, month INT -i, day INT -i, componentId FACET -i, componentName FACET -i,
        componentType FACET -i, totalDuration LONG, minDuration INT, maxDuration INT, noOfInvocation LONG -sp,
        faultCount LONG, startingTime LONG -i, facetStartTime FACET -i, entryPoint FACET -i, _timestamp LONG -i",
        primaryKeys "year, month, day, componentId, componentType",
        mergeSchema "false");

        INSERT INTO TABLE esbServiceStatPerDayAll
        SELECT year, month, day, "ALL", "ALL", "ALL", totalDuration, minDuration, maxDuration,
        noOfInvocation, faultCount, startingTime, facetStartTime, "ALL", _timestamp
        FROM
        (SELECT year, month, day, sum(totalDuration) as totalDuration, min(minDuration) as minDuration,
        max(maxDuration) as maxDuration, sum(noOfInvocation) as noOfInvocation, sum(faultCount) as faultCount,
        getDateStartingTime(year, month, day) as startingTime,
        cast(getDateStartingTime(year, month, day) as STRING) as facetStartTime,
        getDateStartingTime(year, month, day) as _timestamp
        FROM esbServiceStatPerDay
        WHERE componentType = "Proxy Service" OR componentType = "API" OR componentType = "Inbound EndPoint"
        GROUP BY
        year, month, day) temp;

        CREATE TEMPORARY TABLE mediatorStatPerDay USING CarbonAnalytics
        OPTIONS (tableName "mediator-stat-per-day",
        schema "year INT -i, month INT -i, day INT -i, entryPoint FACET -i, entryPointHashcode INT -i, componentIndex
        INT, componentId FACET -i, hashCode INT -i, componentName FACET -i, componentType FACET -i, totalDuration
        LONG, minDuration INT, maxDuration INT, noOfInvocation LONG -sp, faultCount LONG, startingTime LONG -i,
        facetStartTime FACET -i, _timestamp  LONG -i",
        primaryKeys "year, month, day, entryPointHashcode, hashCode, componentId, componentType",
        incrementalParams "mediatorStatPerDay, 2678400",
        mergeSchema "false");

        INSERT INTO TABLE mediatorStatPerDay
        SELECT year, month, day, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode,
        componentName, componentType, sum(totalDuration) as totalDuration, min(minDuration) as minDuration,
        max(maxDuration) as maxDuration, sum(noOfInvocation) as noOfInvocation, sum(faultCount) as faultCount,
        getDateStartingTime(year, month, day) as startingTime,
        cast(getDateStartingTime(year, month, day) as STRING) as facetStartTime,
        getDateStartingTime(year, month, day) as _timestamp
        FROM mediatorStatPerHour
        GROUP BY year, month, day, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode,
        componentName, componentType;

        INCREMENTAL_TABLE_COMMIT mediatorStatPerHour;

        CREATE TEMPORARY TABLE esbServiceStatPerMonth USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Month",
        schema "year INT -i, month INT -i, componentId FACET -i, componentName FACET -i,
        componentType FACET -i, totalDuration LONG, minDuration INT, maxDuration INT, noOfInvocation LONG -sp,
        faultCount LONG, startingTime LONG -i, facetStartTime FACET -i, entryPoint FACET -i, _timestamp LONG -i",
        primaryKeys "year, month, componentId, componentType",
        mergeSchema "false");

        INSERT INTO TABLE esbServiceStatPerMonth
        SELECT year, month, componentId, componentName, componentType, sum(totalDuration) as totalDuration,
        min(minDuration) as minDuration, max(maxDuration) as maxDuration,
        sum(noOfInvocation) as noOfInvocation, sum(faultCount) as faultCount,
        getMonthStartingTime(year, month) as startingTime,
        cast(getMonthStartingTime(year, month) as STRING) as facetStartTime, entryPoint, getMonthStartingTime(year,
        month) as _timestamp
        FROM esbServiceStatPerDay
        GROUP BY year, month, componentId, componentName, componentType, entryPoint;

        INCREMENTAL_TABLE_COMMIT esbServiceStatPerDay;

        CREATE TEMPORARY TABLE esbServiceStatPerMonthAll USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Month",
        schema "year INT -i, month INT -i, componentId FACET -i, componentName FACET -i,
        componentType FACET -i, totalDuration LONG, minDuration INT, maxDuration INT, noOfInvocation LONG -sp,
        faultCount LONG, startingTime LONG -i, facetStartTime FACET -i, entryPoint FACET -i, _timestamp LONG -i",
        primaryKeys "year, month, componentId, componentType",
        mergeSchema "false");

        INSERT INTO TABLE esbServiceStatPerMonthAll
        SELECT year, month, "ALL", "ALL", "ALL", totalDuration, minDuration, maxDuration,
        noOfInvocation, faultCount, startingTime, facetStartTime, "ALL", _timestamp
        FROM
        (SELECT year, month, sum(totalDuration) as totalDuration, min(minDuration) as minDuration,
        max(maxDuration) as maxDuration, sum(noOfInvocation) as noOfInvocation, sum(faultCount) as faultCount,
        getMonthStartingTime(year, month) as startingTime,
        cast(getMonthStartingTime(year, month) as STRING) as facetStartTime,
        getMonthStartingTime(year, month) as _timestamp
        FROM esbServiceStatPerMonth
        WHERE componentType = "Proxy Service" OR componentType = "API" OR componentType = "Inbound EndPoint"
        GROUP BY
        year, month) temp;

        CREATE TEMPORARY TABLE mediatorStatPerMonth USING CarbonAnalytics
        OPTIONS (tableName "mediator-stat-per-month",
        schema "year INT -i, month INT -i, entryPoint FACET -i, entryPointHashcode INT -i, componentIndex INT,
        componentId FACET -i, hashCode INT -i, componentName FACET -i, componentType FACET -i, totalDuration LONG,
        minDuration INT, maxDuration INT, noOfInvocation LONG -sp, faultCount LONG, startingTime LONG -i,
        facetStartTime FACET -i, _timestamp  LONG -i",
        primaryKeys "year, month, entryPointHashcode, hashCode, componentId, componentType",
        mergeSchema "false");

        INSERT INTO TABLE mediatorStatPerMonth
        SELECT year, month, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode,
        componentName, componentType, sum(totalDuration) as totalDuration, min(minDuration) as minDuration,
        max(maxDuration) as maxDuration, sum(noOfInvocation) as noOfInvocation, sum(faultCount) as faultCount,
        getMonthStartingTime(year, month) as startingTime,
        cast(getMonthStartingTime(year, month) as STRING) as facetStartTime,
        getMonthStartingTime(year, month) as _timestamp
        FROM mediatorStatPerDay
        GROUP BY year, month, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode, componentName,
        componentType;

        INCREMENTAL_TABLE_COMMIT mediatorStatPerDay;
    </Script>
    <CronExpression>0 0/5 * * * ?</CronExpression>
</Analytics>
